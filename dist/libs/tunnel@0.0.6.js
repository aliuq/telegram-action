"use strict";require("net");const require$$1=require("tls"),require$$2=require("http"),require$$3=require("https"),require$$4=require("events");require("assert");const require$$0=require("util");function _interopDefaultCompat(d){return d&&typeof d=="object"&&"default"in d?d.default:d}const require$$1__default=_interopDefaultCompat(require$$1),require$$2__default=_interopDefaultCompat(require$$2),require$$3__default=_interopDefaultCompat(require$$3),require$$4__default=_interopDefaultCompat(require$$4),require$$0__default=_interopDefaultCompat(require$$0);var tunnel$1={},hasRequiredTunnel$1;function requireTunnel$1(){if(hasRequiredTunnel$1)return tunnel$1;hasRequiredTunnel$1=1;var d=require$$1__default,g=require$$2__default,O=require$$3__default,E=require$$4__default,$=require$$0__default;tunnel$1.httpOverHttp=b,tunnel$1.httpsOverHttp=x,tunnel$1.httpOverHttps=C,tunnel$1.httpsOverHttps=N;function b(t){var e=new l(t);return e.request=g.request,e}function x(t){var e=new l(t);return e.request=g.request,e.createSocket=y,e.defaultPort=443,e}function C(t){var e=new l(t);return e.request=O.request,e}function N(t){var e=new l(t);return e.request=O.request,e.createSocket=y,e.defaultPort=443,e}function l(t){var e=this;e.options=t||{},e.proxyOptions=e.options.proxy||{},e.maxSockets=e.options.maxSockets||g.Agent.defaultMaxSockets,e.requests=[],e.sockets=[],e.on("free",function(r,u,n,o){for(var s=k(u,n,o),f=0,p=e.requests.length;f<p;++f){var h=e.requests[f];if(h.host===s.host&&h.port===s.port){e.requests.splice(f,1),h.request.onSocket(r);return}}r.destroy(),e.removeSocket(r)})}$.inherits(l,E.EventEmitter),l.prototype.addRequest=function(e,a,r,u){var n=this,o=m({request:e},n.options,k(a,r,u));if(n.sockets.length>=this.maxSockets){n.requests.push(o);return}n.createSocket(o,function(s){s.on("free",f),s.on("close",p),s.on("agentRemove",p),e.onSocket(s);function f(){n.emit("free",s,o)}function p(h){n.removeSocket(s),s.removeListener("free",f),s.removeListener("close",p),s.removeListener("agentRemove",p)}})},l.prototype.createSocket=function(e,a){var r=this,u={};r.sockets.push(u);var n=m({},r.proxyOptions,{method:"CONNECT",path:e.host+":"+e.port,agent:!1,headers:{host:e.host+":"+e.port}});e.localAddress&&(n.localAddress=e.localAddress),n.proxyAuth&&(n.headers=n.headers||{},n.headers["Proxy-Authorization"]="Basic "+new Buffer(n.proxyAuth).toString("base64")),v("making CONNECT request");var o=r.request(n);o.useChunkedEncodingByDefault=!1,o.once("response",s),o.once("upgrade",f),o.once("connect",p),o.once("error",h),o.end();function s(c){c.upgrade=!0}function f(c,i,S){process.nextTick(function(){p(c,i,S)})}function p(c,i,S){if(o.removeAllListeners(),i.removeAllListeners(),c.statusCode!==200){v("tunneling socket could not be established, statusCode=%d",c.statusCode),i.destroy();var q=new Error("tunneling socket could not be established, statusCode="+c.statusCode);q.code="ECONNRESET",e.request.emit("error",q),r.removeSocket(u);return}if(S.length>0){v("got illegal response body from proxy"),i.destroy();var q=new Error("got illegal response body from proxy");q.code="ECONNRESET",e.request.emit("error",q),r.removeSocket(u);return}return v("tunneling connection has established"),r.sockets[r.sockets.indexOf(u)]=i,a(i)}function h(c){o.removeAllListeners(),v(`tunneling socket could not be established, cause=%s
`,c.message,c.stack);var i=new Error("tunneling socket could not be established, cause="+c.message);i.code="ECONNRESET",e.request.emit("error",i),r.removeSocket(u)}},l.prototype.removeSocket=function(e){var a=this.sockets.indexOf(e);if(a!==-1){this.sockets.splice(a,1);var r=this.requests.shift();r&&this.createSocket(r,function(u){r.request.onSocket(u)})}};function y(t,e){var a=this;l.prototype.createSocket.call(a,t,function(r){var u=t.request.getHeader("host"),n=m({},a.options,{socket:r,servername:u?u.replace(/:.*$/,""):t.host}),o=d.connect(0,n);a.sockets[a.sockets.indexOf(r)]=o,e(o)})}function k(t,e,a){return typeof t=="string"?{host:t,port:e,localAddress:a}:t}function m(t){for(var e=1,a=arguments.length;e<a;++e){var r=arguments[e];if(typeof r=="object")for(var u=Object.keys(r),n=0,o=u.length;n<o;++n){var s=u[n];r[s]!==void 0&&(t[s]=r[s])}}return t}var v;return process.env.NODE_DEBUG&&/\btunnel\b/.test(process.env.NODE_DEBUG)?v=function(){var t=Array.prototype.slice.call(arguments);typeof t[0]=="string"?t[0]="TUNNEL: "+t[0]:t.unshift("TUNNEL:"),console.error.apply(console,t)}:v=function(){},tunnel$1.debug=v,tunnel$1}var tunnel,hasRequiredTunnel;function requireTunnel(){return hasRequiredTunnel||(hasRequiredTunnel=1,tunnel=requireTunnel$1()),tunnel}exports.requireTunnel=requireTunnel;
